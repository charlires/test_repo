name: Main

on:
    workflow_dispatch:
        # inputs:
            # pr-number: 
            #     description: 'Pull request number to comment on.'
            #     required: true
    pull_request:
        types: [opened, edited, reopened]

jobs:
    comment-on-pr:
        runs-on: ubuntu-latest
        steps:


          - name: Read Environment Variables
            shell: python
            run: |
              import os

              print("GITHUB_REPOSITORY:", os.getenv('GITHUB_REPOSITORY'))
              print("GITHUB_EVENT_NAME:", os.getenv('GITHUB_EVENT_NAME'))
              print("GITHUB_SHA:", os.getenv('GITHUB_SHA')) 

            env: 
              GITHUB_REPOSITORY: ${{ github.repository }}
              GITHUB_EVENT_NAME: ${{ github.event_name }}
              GITHUB_SHA: ${{ github.sha }}
           
          - name: Write to output
            id: python_step
            shell: python
            run : |
              # STEP 1: Generate the output
              import os
              import time
              
              # 1. calculate some data
              generated_version = "v1.2.3"
              timestamp = str(int(time.time()))
              
              # 2. Prepare the key=value pairs
              # format: name_of_output=value
              
              # 3. Write to the GITHUB_OUTPUT file
              # We use 'a' (append) mode so we don't overwrite previous outputs
              with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                  print(f"version={generated_version}", file=fh)
                  print(f"time={timestamp}", file=fh)
              
              # Optional: Print to logs just so we can see it happening
              print(f"Outputted: version={generated_version}, time={timestamp}")

          # STEP 2: Use the output
          - name: Read Output in Bash
            run: |
              echo "The version from Python is: ${{ steps.python_step.outputs.version }}"
              echo "The timestamp from Python is: ${{ steps.python_step.outputs.time }}"

          - name: Checkout repository
            uses: actions/checkout@v3

          - name: working with files in python
            shell: python
            run : |
              import os

              # Create and write to a file
              with open('example.txt', 'w') as f:
                  f.write('Hello, World!')

              # Read from the file
              with open('example.txt', 'r') as f:
                  content = f.read()
                  print("File content:", content)
              
              # Read an existing file 
              with open('main.go', 'r') as f:
                  workflow_content = f.read()
                  print("Content of main.go:", workflow_content)

          - shell: python
            run : |
              import os
              import subprocess
              print("Hello, this is a placeholder for commenting on a PR.")

              # run command to test 
              result = subprocess.run(['echo', '-n', 'Testing command execution'], capture_output=True, text=True)
              print("Command output:", result.stdout)
              print("Command error (if any):", result.stderr.strip())
              print("Command return code:", result.returncode)

              # Example of a failing command
              fail_result = subprocess.run(['ls', '/nonexistentpath'], capture_output=True, text=True)
              print("Failing command output:", fail_result.stdout)
              print("Failing command error (if any):", fail_result.stderr.strip())
              print("Failing command return code:", fail_result.returncode)

              # Example parsing json output
              json_result = subprocess.run(['echo', '{"key": "value"}'], capture_output=True, text=True)
              import json
              data = json.loads(json_result.stdout)
              print("Parsed JSON data:", data)
              print("Value for 'key':", data['key'])

              # Example parsing yaml output
              yaml_result = subprocess.run(['echo', 'key: value'], capture_output=True, text=True)
              import yaml
              yaml_data = yaml.safe_load(yaml_result.stdout)
              print("Parsed YAML data:", yaml_data)
              print("Value for 'key':", yaml_data['key'])

              # Retry logic example (3 attempts or 1 minute timeout)
              import time
              max_retries = 3
              timeout = 60  # 1 minute in seconds
              start_time = time.time()
              
              for attempt in range(max_retries):
                elapsed_time = time.time() - start_time
                if elapsed_time >= timeout:
                  print("Timeout reached after", elapsed_time, "seconds")
                  break
                
                try:
                  # Simulate a command that may fail
                  if attempt < 2:
                    raise Exception("Simulated failure")
                  print("Command succeeded on attempt", attempt + 1)
                  break
                except Exception as e:
                  print("Attempt", attempt + 1, "failed:", str(e))
                  if attempt < max_retries - 1:
                    time.sleep(2)
                  else:
                    print("All attempts failed.")

        